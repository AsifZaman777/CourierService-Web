@model Parcel


@{
    ViewData["Title"] = "Add Parcel";
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";
}
@{
    string RiderId = Context.Request.Cookies["RiderId"];
    string AdminId = Context.Request.Cookies["AdminId"];
    string MerchantId = Context.Request.Cookies["MerchantId"];


}

<style>
    
    input[readonly] {
        background-color: #f8f9fa; 
        color: black; 
        border-color: #ced4da; 
    }

    
    label[for="DeliveryCharge"], label[for="TotalPrice"] {
        color: #007bff; 
    }
</style>

<div class="content-page">
    <div class="content">
        <div class="container-fluid">
            <div class="row mt-5 justify-content-center align-content-center">
                <div class="col-lg-6">
                    <div>
                        <h4 class="header-title">Add a New Parcel</h4>

                        <form method="post" enctype="multipart/form-data">
                            

                            
                            <input asp-for="MerchantId" type="hidden" name="MerchantId" value="@MerchantId" />

                           
                              
                                  <div class="form-group mt-3">
                                    <label for="HubId">Select Hub<span class="text-danger">*</span></label>
                                    <select name="HubId" class="form-control" id="">
                                    @foreach (var hub in ViewBag.HubList)
                                    {
                                        //check area
                                        if (hub.Area == ViewBag.MerchantArea)
                                        {
                                            <option value="@hub.Id" >@hub.Name</option>

                                        }
                                        @* else if(hub.Area != ViewBag.MerchantArea)
                                        {
                                            <option value="@hub.Id" disabled>@hub.Name</option>
                                        } *@
                                    }

                                    </select>
                                   </div>
                            
                            <div class="form-group">
                                <label asp-for="PickupLocation" for="PickupLocation">Pickup Location<span class="text-danger">*</span></label>
                                <select name="PickupOption" id="PickupOption" class="form-control">
                                    <option value="Self">Self</option>
                                    <option value="Other">Other</option>
                                </select>
                               
                                <input asp-for="PickupLocation" type="text" name="PickupLocation" parsley-trigger="change" required
                                       placeholder="Enter Pickup Location" class="form-control" id="PickupLocation">
                                <span asp-validation-for="PickupLocation" class="text-danger"></span>
                            </div>

                            <div class="form-group">
                                <label asp-for="ReceiverName" for="ReceiverName">Receiver Name<span class="text-danger">*</span></label>
                                <input asp-for="ReceiverName" type="text" name="ReceiverName" parsley-trigger="change" required
                                       placeholder="Enter Receiver Name" class="form-control" id="ReceiverName">
                                <span asp-validation-for="ReceiverName" class="text-danger"></span>
                            </div>
                            <div class="form-group">
                                <label asp-for="ReceiverAddress" for="ReceiverAddress">Receiver Address<span class="text-danger">*</span></label>
                                <input asp-for="ReceiverAddress" type="text" name="ReceiverAddress" parsley-trigger="change" required
                                       placeholder="Enter Receiver Address" class="form-control" id="ReceiverAddress">
                                <span asp-validation-for="ReceiverAddress" class="text-danger"></span>
                            </div>
                            <div class="form-group">
                                <label asp-for="ReceiverContactNumber" for="ReceiverContactNumber">Receiver Contact Number<span class="text-danger">*</span></label>
                                <input asp-for="ReceiverContactNumber" type="text" name="ReceiverContactNumber" parsley-trigger="change" required
                                       placeholder="Enter Receiver Contact Number" class="form-control" id="ReceiverContactNumber">
                                <span asp-validation-for="ReceiverContactNumber" class="text-danger"></span>
                            </div>
                            <div class="form-group">
                                <label asp-for="ReceiverEmail" for="ReceiverEmail">Receiver Email<span class="text-danger"></span></label>
                                <input asp-for="ReceiverEmail" type="email" name="ReceiverEmail" parsley-trigger="change" 
                                       placeholder="Enter Receiver Email" class="form-control" id="ReceiverEmail">
                                <span asp-validation-for="ReceiverEmail" class="text-danger"></span>
                            </div>
                            <div class="form-group">
                                <label asp-for="ProductName" for="ProductName">Product Name<span class="text-danger">*</span></label>
                                <input asp-for="ProductName" type="text" name="ProductName" parsley-trigger="change" required
                                       placeholder="Enter Product Name" class="form-control" id="ProductName">
                                <span asp-validation-for="ProductName" class="text-danger"></span>
                            </div>
                            <div class="form-group">
                                <label asp-for="ProductWeight" for="ProductWeight">Product Weight<span class="text-danger">*</span></label>
                                <select asp-for="ProductWeight" name="ProductWeight" class="form-control" id="ProductWeight">
                                    <option value="0.5">0.5 KG</option>
                                    <option value="1">1 KG</option>
                                    <option value="2">2 KG</option>
                                    <option value="3">3 KG</option>
                                    <option value="4">4 KG</option>
                                    <option value="5">5 KG</option>
                                    <option value="6">6 KG</option>
                                    <option value="7">7 KG</option>
                                    <option value="8">8 KG</option>
                                    <option value="9">9 KG</option>
                                    <option value="10">10 KG</option>
                                   
                                </select>
                                <span asp-validation-for="ProductWeight" class="text-danger"></span>
                            </div>
                            <div class="form-group">
                                <label asp-for="DeliveryType" for="DeliveryType">Delivery Type<span class="text-danger">*</span></label>
                                <select asp-for="DeliveryType" name="DeliveryType" id="DeliveryType" class="form-control">
                                    <option value="InsideDhaka">Inside Dhaka</option>
                                    <option value="SubDhaka">Sub Dhaka</option>
                                    <option value="OutsideDhaka">Outside Dhaka</option>
                                    <option value="InDhakaEmergency">In Dhaka Emergency</option>
                                    <option value="P2P">P2P Parcel</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label asp-for="ProductPrice" for="ProductPrice">Product Price<span class="text-danger">*</span></label>
                                <input asp-for="ProductPrice" type="number" name="ProductPrice" parsley-trigger="change" required
                                       placeholder="Enter Product Price" class="form-control" id="ProductPrice">
                                <span asp-validation-for="ProductPrice" class="text-danger"></span>
                            </div>
                            <div class="form-group">
                                <label asp-for="ProductQuantity" for="ProductQuantity">Product Quantity<span class="text-danger"></span></label>
                                <input asp-for="ProductQuantity" type="number" name="ProductQuantity" parsley-trigger="change" 
                                       placeholder="Enter Product Quantity" class="form-control" id="ProductQuantity">
                                <span asp-validation-for="ProductQuantity" class="text-danger"></span>
                            </div>
                            <div class="form-group">
                                <label asp-for="DeliveryCharge" for="DeliveryCharge">Delivery Charge<span class="text-danger">*</span></label>
                                <input asp-for="DeliveryCharge" type="number" name="DeliveryCharge" parsley-trigger="change" required
                                       placeholder="Enter Delivery Charge" class="form-control" id="DeliveryCharge" readonly>
                                <span asp-validation-for="DeliveryCharge" class="text-danger"></span>
                            </div>

                            <div class="form-group">
                                <label asp-for="COD" for="COD">COD Charge<span class="text-danger">*</span></label>
                                <input asp-for="COD" type="number" name="COD" parsley-trigger="change" required
                                       placeholder="Enter COD" class="form-control" id="COD" readonly>
                                <span asp-validation-for="COD" class="text-danger"></span>
                            </div>
                            <div class="form-group">
                                <label asp-for="TotalPrice"  for="TotalPrice">Total Price<span class="text-danger"></span></label>
                                <input asp-for="TotalPrice" type="number" name="TotalPrice" parsley-trigger="change" required
                                       placeholder="Total Price" class="form-control" id="TotalPrice" readonly>
                                <span asp-validation-for="TotalPrice" class="text-danger"></span>
                            </div>

                            

                            <div class="form-group text-right mb-0">
                                <button asp-controller="Merchant" asp-action="AddParcel" class="btn btn-primary waves-effect waves-light mr-1" type="submit">
                                    Submit
                                </button>
                                <button type="reset" class="btn btn-secondary waves-effect">
                                    Reset
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <!-- end row -->
        </div>
    </div>
</div>


<script>
    document.addEventListener("DOMContentLoaded", function () {
        var productWeightSelect = document.getElementById("ProductWeight");
        var deliveryTypeSelect = document.getElementById("DeliveryType");
        var productPriceInput = document.getElementById("ProductPrice");
        var productQuantityInput = document.getElementById("ProductQuantity");
        var deliveryChargeInput = document.getElementById("DeliveryCharge");
        var codInput = document.getElementById("COD");
        var totalPriceInput = document.getElementById("TotalPrice");

        function calculateDeliveryCharge() {
            var productWeight = parseInt(productWeightSelect.value);
            var deliveryType = deliveryTypeSelect.value;
            var deliveryCharge = 0;

            // Calculate delivery charge based on product weight and delivery type
            if (deliveryType === "InsideDhaka") {
                if (productWeight <= 1) {
                    deliveryCharge = 70;
                } else {
                    deliveryCharge = 70 + (productWeight - 1) * 15;
                }
            } else if (deliveryType === "SubDhaka") {
                if (productWeight <= 1) {
                    deliveryCharge = 90;
                } else {
                    deliveryCharge = 90 + (productWeight - 1) * 15;
                }
            } else if (deliveryType === "OutsideDhaka") {
                if (productWeight <= 1) {
                    deliveryCharge = 120;
                } else {
                    deliveryCharge = 120 + (productWeight - 1) * 15;
                }
            } else if (deliveryType === "InDhakaEmergency") {
                if (productWeight <= 1) {
                    deliveryCharge = 100;
                } else {
                    deliveryCharge = 100 + (productWeight - 1) * 15;
                }
            } else if (deliveryType === "P2P") {
                if (productWeight <= 1) {
                    deliveryCharge = 200;
                } else {
                    deliveryCharge = 200 + (productWeight - 1) * 15;
                }
            }

            return deliveryCharge;
        }

        function calculateCOD() {
            var productPrice = parseInt(productPriceInput.value);
            var codCharge = Math.round(productPrice * 0.01); // Calculate COD charge (1% of product price)
            return codCharge;
        }

        //calculate weight price
        function calculateWeightPrice() {
            var productWeight = parseInt(productWeightSelect.value);
            var productPrice = parseInt(productPriceInput.value);
            var weightPrice = productWeight * productPrice;
            return weightPrice;
        }

        function calculateTotalPrice() {
            var deliveryCharge = calculateDeliveryCharge();
            var codCharge = calculateCOD();
            var productPrice = parseInt(productPriceInput.value);
            var productQuantity = parseInt(productQuantityInput.value);
            var totalPrice = (productPrice + codCharge)  + deliveryCharge;
            return totalPrice;
        }

        function updatePrices() {
            var deliveryCharge = calculateDeliveryCharge();
            var codCharge = calculateCOD();
            var totalPrice = calculateTotalPrice();

            // Set the calculated delivery charge, COD charge, and total price to the input fields
            deliveryChargeInput.value = deliveryCharge;
            codInput.value = codCharge;
            totalPriceInput.value = totalPrice;
        }

        // Call the function initially
        updatePrices();

        // Call the function whenever inputs change
        productWeightSelect.addEventListener("change", updatePrices);
        deliveryTypeSelect.addEventListener("change", updatePrices);
        productPriceInput.addEventListener("change", updatePrices);
        productQuantityInput.addEventListener("change", updatePrices);
    });
</script>


<script>
    document.addEventListener("DOMContentLoaded", function () {
        var pickupOptionSelect = document.getElementById("PickupOption");
        var pickupLocationInput = document.getElementById("PickupLocation");

        function togglePickupLocationInput() {
            if (pickupOptionSelect.value === "Self") {
                // Set the value of the input field to the merchant's full address from ViewBag
                pickupLocationInput.value = '@ViewBag.MerchantFullAddress';
                pickupLocationInput.setAttribute('readonly', true); // Make the input readonly
                pickupLocationInput.style.display = "block";
            } else {
                pickupLocationInput.removeAttribute('readonly'); // Remove the readonly attribute
                pickupLocationInput.style.display = "block";
                pickupLocationInput.value = "";
            }
        }



        // Call the function initially
        togglePickupLocationInput();

        // Call the function whenever pickup option changes
        pickupOptionSelect.addEventListener("change", togglePickupLocationInput);
    });
</script>




@section Scripts {

    <button id="downloadBtn" class="btn btn-primary">Download CSV Template</button>

    @* <script>
        document.getElementById('downloadBtn').addEventListener('click', function () {
            // CSV content with headers and sample data
            var csvContent = "Id,ReceiverName,ReceiverAddress,ReceiverContactNumber,ReceiverEmail,ProductName,ProductWeight,ProductPrice,ProductQuantity,DeliveryCharge,Status,PickupRequestDate,DispatchDate,DeliveryDate,CancelDate,ReturnDate,PaymentStatus,PaymentInHand,PickupLocation,DeliveryType,TotalPrice,MerchantId,RiderId,HubId,ReturnId,DeliveryId,ExchangeId,COD\n";
            csvContent += "P-1234,John Doe,123 Main St,0123456789,johndoe@example.com,Sample Product,2,50,1,10,Pickup Request,2024-03-29T12:00:00,2024-03-30T12:00:00,2024-04-02T12:00:00,,2024-04-03T12:00:00,Success,Completed,My Office,InsideDhaka,60,123,R123,H123,RID123,DID123,EID123,20\n";
            csvContent += "P-5678,Jane Smith,456 Elm St,9876543210,janesmith@example.com,Another Product,1,30,2,15,Pickup Request,2024-03-30T12:00:00,2024-03-31T12:00:00,2024-04-03T12:00:00,2024-04-04T12:00:00,2024-04-06T12:00:00,Pending,Not Received,Home,SubDhaka,45,456,R456,H456,RID456,DID456,EID456,10\n";

            // Create a Blob containing the CSV data
            var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });

            // Create a download link
            var link = document.createElement("a");
            if (link.download !== undefined) { // Feature detection
                // Create a temporary link element
                var url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "parcel_template.csv");

                // Trigger the download
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        });
    </script> *@

    @{
            <partial name="_ValidationScriptsPartial" />
    }
}
